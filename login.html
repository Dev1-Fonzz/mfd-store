<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login ‚Ä¢ MFD Store</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="digital-clock" id="clock">Loading...</div>
  <div class="container">
    <div class="card">
      <h2>üîë Login ke Akaun Anda</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>Nombor Telefon *</label>
          <input type="text" id="phone" required placeholder="0123456789" />
        </div>
        <div class="form-group">
          <label>Kata Laluan *</label>
          <input type="password" id="password" required placeholder="Kata laluan anda" />
        </div>
        <button type="submit">üîì Login Sekarang</button>
      </form>
      <div id="message" class="message"></div>
      <p>Belum ada akaun? <a href="register.html" style="color:#4361ee;">Daftar di sini</a></p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="js/utils.js"></script>
<script>
  function showMessage(text, isSuccess = true) {
    const msgDiv = document.getElementById('message');
    msgDiv.textContent = text;
    msgDiv.className = `message ${isSuccess ? 'success' : 'error'}`;
    msgDiv.style.display = 'block';
  }

  function hashPassword(password) {
    return CryptoJS.SHA256(password).toString();
  }

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const phone = document.getElementById('phone').value.trim();
    const password = document.getElementById('password').value;
    const btn = document.getElementById('loginBtn');

    // Validasi
    if (!/^\d{10,11}$/.test(phone)) {
      showMessage("Nombor telefon mesti 10-11 digit", false);
      return;
    }
    if (password.length < 6) {
      showMessage("Kata laluan mesti sekurang-kurangnya 6 aksara", false);
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sedang login...';
    showMessage("Menghantar permintaan...", true);

    try {
      const hashedPass = hashPassword(password);
      
      // üîÅ GUNA POST REQUEST (SAMA MACAM REGISTER)
      const formData = new URLSearchParams();
      formData.append('action', 'login');
      formData.append('phone', phone);
      formData.append('password', hashedPass);

      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      });

      const data = await response.json();

      if (data.success) {
        localStorage.setItem('uac', data.uac);
        localStorage.setItem('username', data.username);
        showMessage("‚úÖ Login berjaya! Mengalihkan...", true);
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1200);
      } else {
        showMessage("‚ùå Gagal login: " + (data.message || "Nombor atau kata laluan salah"), false);
      }
    } catch (err) {
      console.error("Login error:", err);
      showMessage("Ralat sistem: Gagal sambung ke pelayan.", false);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login Sekarang';
    }
  });

  // Jam digital
  function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('ms-MY', { hour12: false });
    const dateString = now.toLocaleDateString('ms-MY', { 
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
    });
    document.getElementById('clock').innerHTML = `${timeString}<br>${dateString}`;
  }
  updateClock();
  setInterval(updateClock, 1000);
</script>
</body>
</html>
